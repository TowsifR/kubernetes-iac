# CLAUDE.md

This is a learning project that mirrors enterprise Kubernetes infrastructure patterns using local tools (KinD, Terraform, Kustomize, Flux).

## Project Purpose

Learn infrastructure-as-code patterns from production repos:
- `oneai-core-infra` (Terraform/EKS) → `terraform/` (Terraform/KinD)
- `oneai-core-fleet-infra` (Flux/Helm) → `kubernetes/` (Flux + Kustomize)

## Directory Structure

```
kubernetes-iac/
├── terraform/              # Cluster creation + Flux bootstrap
│   ├── main/               # Root module
│   │   ├── flux.tf         # Flux bootstrap config
│   │   ├── terraform.tfvars.example
│   │   └── tfvars/         # Environment configs
│   ├── modules/            # Reusable modules
│   └── Makefile            # Simplified commands
├── kubernetes/             # GitOps - managed by Flux
│   ├── apps/
│   │   └── base/
│   │       ├── kustomization.yaml
│   │       ├── localstack/   # LocalStack Helm chart (via Flux HelmRelease)
│   │       └── crossplane/   # Crossplane + AWS provider → LocalStack (in progress)
│   └── clusters/
│       └── dev/services/
│           ├── flux-system/  # Auto-generated by Flux
│           ├── kustomization.yaml
│           └── crossplane-*.yaml  # Flux Kustomization CRDs (in progress)
├── docs/                   # Implementation plans and reference docs
│   └── crossplane-implementation.md
├── .env                    # GitHub token (gitignored)
└── plan.md                 # Full implementation plan (reference)
```

## Quick Start (Makefile)

```bash
# Prerequisites
# 1. Docker Desktop running (WSL2 integration enabled)
# 2. Create .env file with: export TF_VAR_github_token=ghp_xxx

cd terraform

make init      # Initialize Terraform
make cluster   # Create cluster + bootstrap Flux
make destroy   # Tear down cluster
make clean     # Remove all clusters + Terraform cache

# Shortcuts
make dev-services   # Create dev services cluster
make dev-workloads  # Create dev workloads cluster
```

## Manual Terraform Commands

If you prefer running Terraform directly (from `terraform/main/`):

```bash
# Initialize
terraform init

# Plan
terraform plan \
  -var-file="tfvars/dev.tfvars" \
  -var="cluster_name=services-dev" \
  -var="cluster_type=services"

# Apply
terraform apply \
  -var-file="tfvars/dev.tfvars" \
  -var="cluster_name=services-dev" \
  -var="cluster_type=services"

# Destroy
terraform destroy \
  -var-file="tfvars/dev.tfvars" \
  -var="cluster_name=services-dev" \
  -var="cluster_type=services"
```

Note: GitHub token must be set via `export TF_VAR_github_token=...` or `.env` file.

## Flux (GitOps)

Flux is bootstrapped via Terraform. After `make cluster`:

```bash
# Check Flux is running
kubectl get pods -n flux-system

# Check Flux sync status
kubectl get kustomizations -n flux-system
```

**How it works:**
1. Terraform creates KinD cluster
2. Terraform bootstraps Flux into the cluster
3. Flux watches `kubernetes/clusters/dev/services/` in Git
4. Push changes to Git → Flux auto-applies to cluster

## Cluster Types
- `services` - Platform services (ingress, cert-manager, argocd)
- `workloads` - Application workloads (batch-jobs, data-processing)

## Environments
- `dev` - 1 worker node
- `prod` - 2 worker nodes

## Best Practices

### Terraform
- Use Makefile for common operations
- Keep secrets in `.env` (gitignored), not in tfvars
- Identity config (github_owner, repo) in `terraform.tfvars` (gitignored)
- Environment config (k8s version, worker count) in `tfvars/dev.tfvars` (committed)

### Flux/GitOps
- Don't `kubectl apply` manually - push to Git instead
- Flux auto-syncs every 1 minute
- Check `kubectl get kustomizations -A` for sync status

### Git
- Never commit: `.terraform/`, `*.tfstate`, `*-config`, `.env`, `terraform.tfvars`
- Flux commits to `kubernetes/clusters/*/flux-system/` - don't edit these manually

## Current Progress

- [x] Part 1: Terraform (KinD cluster creation)
- [x] Flux bootstrap via Terraform
- [x] Makefile for unified commands
- [x] LocalStack Helm chart via Flux (apps/base/localstack/)
- [ ] Crossplane + AWS provider → LocalStack (apps/base/crossplane/) — see docs/crossplane-implementation.md
- [ ] Part 2: Kubernetes manifests (infrastructure/ layer, namespaces, resource-quotas)
- [ ] Calico network policies
- [ ] Monitoring (kube-prometheus-stack)
- [ ] GitHub Actions CI/CD

## When Helping With This Project

1. This is a **learning project** - explain concepts, don't just write code
2. Follow patterns from `plan.md` - it's the reference implementation
3. Use best judgment - follow industry best practices but keep complexity appropriate for this scaled-down learning project
4. Document everything - READMEs for each major directory
5. Test changes before committing
6. Keep commits atomic and well-described
